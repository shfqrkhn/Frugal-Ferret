import{r as P,j as e,P as W,e as J,B as y,g as Q,az as oe,aA as ie,aB as ce,aC as le,aD as de,aE as $,c as F,q as U,a as he,u as k,Y as xe,Z as me,$ as je,a0 as w,a1 as T,a2 as S,a3 as b,aF as ue,a4 as D,I as pe,f as H,C as ge,i as L,k as B,l as O,m as R,n as I,a5 as q,aG as ye,_ as Ce,aH as fe,a6 as E,au as ve,at as Ne,d as N,a8 as we,a9 as Te,aa as Se,ab as be,ac as De,ar as Ae,v,x as z,aI as _,K,M as Y,N as Z,O as X,Q as ee,R as ae,U as se,V as ne,W as te,o as Ie,T as Fe,E as Me,F as G,G as C,H as Ee,J as f,aJ as Pe}from"./index-DwbuEFEH.js";import{u as Ue}from"./use-mobile-GAj-Qur4.js";import{C as ke,a as ze,d as He,e as $e}from"./card-DdU8Mv6S.js";import{E as Le}from"./EmptyState-CVo49N0l.js";const re=({transactionId:s,selectedCategoryId:c,categories:r,onCategoryChange:u})=>{var m;const[t,l]=P.useState(!1),h=(m=r.find(o=>o.id===c))==null?void 0:m.name,d=async o=>{await u(s,o),U("Category updated!"),l(!1)};return e.jsxs(W,{open:t,onOpenChange:l,children:[e.jsx(J,{asChild:!0,children:e.jsxs(y,{variant:"outline",role:"combobox","aria-expanded":t,className:"w-[180px] justify-between text-xs h-8",children:[e.jsx("span",{className:"truncate",children:h||"Uncategorized"}),e.jsx("span",{className:"ml-2 h-4 w-4 shrink-0 opacity-50",children:"↕️"})]})}),e.jsx(Q,{className:"w-[200px] p-0",children:e.jsxs(oe,{children:[e.jsx(ie,{placeholder:"Search category..."}),e.jsxs(ce,{children:[e.jsx(le,{children:"No category found."}),e.jsxs(de,{children:[e.jsxs($,{onSelect:()=>d(void 0),children:[e.jsx("span",{className:F("mr-2 h-4 w-4",c?"opacity-0":"opacity-100"),children:"✅"}),"Uncategorized"]}),r.map(o=>e.jsxs($,{value:o.name,onSelect:()=>d(o.id),children:[e.jsx("span",{className:F("mr-2 h-4 w-4",c===o.id?"opacity-100":"opacity-0"),children:"✅"}),o.name]},o.id))]})]})]})})]})},Be=Ce({date:Ne({required_error:"A date is required."}),description:E().min(2,{message:"Description must be at least 2 characters."}),amount:ve.number().refine(s=>s!==0,{message:"Amount cannot be zero."}),accountId:E().min(1,{message:"Please select an account."}),categoryId:E().optional(),tags:fe(E()).optional()}),Oe=({onSubmit:s,onCancel:c,initialValues:r})=>{var p,A;const{openAddAccountDialog:u,openCategoryDialog:t,openPayeeDialog:l,openTagDialog:h}=he(),d=k(()=>N.accounts.toArray(),[]),m=k(()=>N.categories.orderBy("name").toArray(),[]),o=k(()=>N.tags.orderBy("name").toArray(),[]),M=(o==null?void 0:o.map(n=>({value:n.id.toString(),label:n.name})))||[],x=xe({resolver:me(Be),defaultValues:{date:r.date,description:r.description,amount:r.amount,accountId:r.accountId.toString(),categoryId:((p=r.categoryId)==null?void 0:p.toString())||void 0,tags:((A=r.tags)==null?void 0:A.map(n=>n.toString()))||[]}}),a=n=>{n.defaultCategoryId&&x.setValue("categoryId",n.defaultCategoryId.toString())},j=n=>{l({name:n})},g=n=>{h({name:n})};return e.jsx(je,{...x,children:e.jsxs("form",{onSubmit:x.handleSubmit(s),className:"space-y-4",children:[e.jsx(w,{control:x.control,name:"description",render:({field:n})=>e.jsxs(T,{children:[e.jsx(S,{children:"Description"}),e.jsx(b,{children:e.jsx(ue,{value:n.value,onValueChange:n.onChange,onPayeeSelect:a,onAddNewPayee:j})}),e.jsx(D,{})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(w,{control:x.control,name:"amount",render:({field:n})=>e.jsxs(T,{children:[e.jsx(S,{children:"Amount"}),e.jsx(b,{children:e.jsx(pe,{type:"number",step:"0.01",placeholder:"0.00",...n})}),e.jsx(D,{})]})}),e.jsx(w,{control:x.control,name:"date",render:({field:n})=>e.jsxs(T,{children:[e.jsx(S,{children:"Transaction Date"}),e.jsxs(W,{children:[e.jsx(J,{asChild:!0,children:e.jsx(b,{children:e.jsxs(y,{variant:"outline",className:F("w-full pl-3 text-left font-normal",!n.value&&"text-muted-foreground"),children:[n.value?H(n.value,"PPP"):e.jsx("span",{children:"Pick a date"}),e.jsx("span",{className:"ml-auto h-4 w-4 opacity-50",children:"📅"})]})})}),e.jsx(Q,{className:"w-auto p-0",align:"start",children:e.jsx(ge,{mode:"single",selected:n.value,onSelect:n.onChange,disabled:i=>i>new Date||i<new Date("1900-01-01"),initialFocus:!0})})]}),e.jsx(D,{})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(w,{control:x.control,name:"accountId",render:({field:n})=>e.jsxs(T,{children:[e.jsx(S,{children:"Account"}),e.jsxs(L,{onValueChange:i=>{i==="add-new"?u():n.onChange(i)},value:n.value,children:[e.jsx(b,{children:e.jsx(B,{children:e.jsx(O,{placeholder:"Select an account"})})}),e.jsxs(R,{children:[d==null?void 0:d.map(i=>e.jsx(I,{value:i.id.toString(),children:i.name},i.id)),e.jsx(q,{}),e.jsx(I,{value:"add-new",children:e.jsx("span",{className:"font-medium text-primary",children:"➕ Add new account..."})})]})]}),e.jsx(D,{})]})}),e.jsx(w,{control:x.control,name:"categoryId",render:({field:n})=>e.jsxs(T,{children:[e.jsx(S,{children:"Category (Optional)"}),e.jsxs(L,{onValueChange:i=>{i==="add-new"?t():n.onChange(i)},value:n.value,children:[e.jsx(b,{children:e.jsx(B,{children:e.jsx(O,{placeholder:"Select a category"})})}),e.jsxs(R,{children:[e.jsx(I,{value:"none",children:"Uncategorized"}),m==null?void 0:m.map(i=>e.jsx(I,{value:i.id.toString(),children:i.name},i.id)),e.jsx(q,{}),e.jsx(I,{value:"add-new",children:e.jsx("span",{className:"font-medium text-primary",children:"➕ Add new category..."})})]})]}),e.jsx(D,{})]})})]}),e.jsx(w,{control:x.control,name:"tags",render:({field:n})=>e.jsxs(T,{children:[e.jsx(S,{children:"Tags (Optional)"}),e.jsx(b,{children:e.jsx(ye,{options:M,selected:n.value||[],onChange:n.onChange,placeholder:"Select tags...",onAddNew:g})}),e.jsx(D,{})]})}),e.jsxs("div",{className:"flex justify-end space-x-2 pt-4",children:[e.jsx(y,{type:"button",variant:"outline",onClick:c,children:"Cancel"}),e.jsx(y,{type:"submit",children:"Save Changes"})]})]})})},V=({transaction:s,onClose:c,onSave:r})=>{const u=async t=>{var l;if(s!=null&&s.id)try{const h={date:t.date,description:t.description,amount:t.amount,accountId:parseInt(t.accountId,10),categoryId:t.categoryId&&t.categoryId!=="none"?parseInt(t.categoryId,10):void 0,tags:(l=t.tags)==null?void 0:l.map(m=>parseInt(m,10))},d={...h,uniqueHash:Ae(h)};await N.transactions.update(s.id,d),v.info("Transaction updated",{id:s.id,...d}),U("Transaction updated successfully!"),r(),c()}catch(h){v.error("Failed to update transaction",{error:h,values:t}),z("Failed to update transaction.")}};return e.jsx(we,{open:!!s,onOpenChange:c,children:e.jsxs(Te,{children:[e.jsxs(Se,{children:[e.jsx(be,{children:"Edit Transaction"}),e.jsx(De,{children:"Update the details for your transaction below."})]}),s&&e.jsx(Oe,{onSubmit:u,onCancel:c,initialValues:s})]})})},Re=({transaction:s,accountName:c,categories:r,tagMap:u,onCategoryChange:t,onEdit:l,onDelete:h})=>e.jsxs(ke,{children:[e.jsx(ze,{className:"pb-2",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex-grow",children:[e.jsx("p",{className:"font-semibold",children:s.description}),e.jsx("p",{className:"text-sm text-muted-foreground",children:c})]}),e.jsx("p",{className:F("font-mono text-lg",s.amount<0?"text-destructive":"text-green-600"),children:s.amount.toLocaleString("en-US",{style:"currency",currency:"CAD"})})]})}),e.jsxs(He,{className:"py-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:H(s.date,"MMM d, yyyy")}),e.jsx(re,{transactionId:s.id,selectedCategoryId:s.categoryId,categories:r,onCategoryChange:t})]}),s.tags&&s.tags.length>0&&e.jsx("div",{className:"flex flex-wrap gap-1 pt-2",children:s.tags.map(d=>e.jsx(_,{variant:"outline",children:u.get(d)},d))})]}),e.jsxs($e,{className:"flex justify-end gap-2 py-2",children:[e.jsxs(y,{variant:"ghost",size:"sm",onClick:()=>l(s),children:[e.jsx("span",{className:"mr-1",children:"✏️"})," Edit"]}),e.jsxs(K,{children:[e.jsx(Y,{asChild:!0,children:e.jsxs(y,{variant:"ghost",size:"sm",className:"text-destructive hover:text-destructive",children:[e.jsx("span",{className:"mr-1",children:"🗑️"})," Delete"]})}),e.jsxs(Z,{children:[e.jsxs(X,{children:[e.jsx(ee,{children:"Are you sure?"}),e.jsx(ae,{children:"This will permanently delete this transaction. This action cannot be undone."})]}),e.jsxs(se,{children:[e.jsx(ne,{children:"Cancel"}),e.jsx(te,{onClick:()=>h(s.id),children:"Delete"})]})]})]})]})]}),Je=({transactions:s,accounts:c,categories:r,tags:u})=>{const[t,l]=P.useState(null),h=Ue(),d=Ie(),m=P.useMemo(()=>new Map(c.map(a=>[a.id,a.name])),[c]),o=P.useMemo(()=>new Map(u.filter(a=>a.id!==void 0).map(a=>[a.id,a.name])),[u]),M=async(a,j)=>{const g=s.find(p=>p.id===a);if(g)try{if(await N.transactions.update(a,{categoryId:j}),v.info(`Updated category for transaction ${a}`,{categoryId:j}),U("Category updated!"),j){const p=await N.transactions.where({description:g.description}).filter(A=>A.id!==a&&A.categoryId===void 0).count();p>0&&(v.info(`Found ${p} other transactions that could be auto-categorized.`),Pe("Create a rule for this?",{description:`We found ${p} other transaction(s) for "${g.description}".`,action:{label:"Create Rule",onClick:()=>d(`/settings?tab=rules&description=${encodeURIComponent(g.description)}&categoryId=${j}`)}}))}}catch(p){v.error(`Failed to update category for transaction ${a}`,{error:p}),z("Failed to update category.")}},x=async a=>{try{await N.transactions.delete(a),U("Transaction deleted."),v.info(`Transaction ${a} deleted.`)}catch(j){z("Failed to delete transaction."),v.error(`Failed to delete transaction ${a}`,{error:j})}};return s.length===0?e.jsx(Le,{icon:"🧾",title:"No Transactions Found",description:"No transactions match your current filters. Try adjusting your search or adding a new transaction."}):h?e.jsxs("div",{className:"space-y-4",children:[s.map(a=>e.jsx(Re,{transaction:a,accountName:m.get(a.accountId)||"Unknown",categories:r,tagMap:o,onCategoryChange:M,onEdit:l,onDelete:x},a.id)),e.jsx(V,{transaction:t,onClose:()=>l(null),onSave:()=>{}})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"rounded-md border",children:e.jsxs(Fe,{children:[e.jsx(Me,{children:e.jsxs(G,{children:[e.jsx(C,{children:"Date"}),e.jsx(C,{children:"Account"}),e.jsx(C,{children:"Description"}),e.jsx(C,{children:"Category"}),e.jsx(C,{children:"Tags"}),e.jsx(C,{className:"text-right",children:"Amount"}),e.jsx(C,{className:"text-right",children:"Actions"})]})}),e.jsx(Ee,{children:s.map(a=>{var j;return e.jsxs(G,{children:[e.jsx(f,{children:H(a.date,"MMM d, yyyy")}),e.jsx(f,{children:m.get(a.accountId)||"Unknown"}),e.jsx(f,{className:"font-medium",children:a.description}),e.jsx(f,{children:e.jsx(re,{transactionId:a.id,selectedCategoryId:a.categoryId,categories:r,onCategoryChange:M})}),e.jsx(f,{children:e.jsx("div",{className:"flex flex-wrap gap-1",children:(j=a.tags)==null?void 0:j.map(g=>e.jsx(_,{variant:"outline",children:o.get(g)||"..."},g))})}),e.jsx(f,{className:F("text-right font-mono",a.amount<0?"text-destructive":"text-green-600"),children:a.amount.toLocaleString("en-US",{style:"currency",currency:"CAD"})}),e.jsxs(f,{className:"text-right",children:[e.jsx(y,{variant:"ghost",size:"icon",onClick:()=>l(a),children:"✏️"}),e.jsxs(K,{children:[e.jsx(Y,{asChild:!0,children:e.jsx(y,{variant:"ghost",size:"icon",children:e.jsx("span",{className:"text-destructive",children:"🗑️"})})}),e.jsxs(Z,{children:[e.jsxs(X,{children:[e.jsx(ee,{children:"Are you sure?"}),e.jsx(ae,{children:"This will permanently delete this transaction. This action cannot be undone."})]}),e.jsxs(se,{children:[e.jsx(ne,{children:"Cancel"}),e.jsx(te,{onClick:()=>x(a.id),children:"Delete"})]})]})]})]})]},a.id)})})]})}),e.jsx(V,{transaction:t,onClose:()=>l(null),onSave:()=>{}})]})};export{Je as T};
