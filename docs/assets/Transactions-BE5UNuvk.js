import{b as D,j as e,c as T,P as B,e as V,B as A,f as z,g as _,C as G,h as I,I as O,i as b,k as R,l as P,m as U,n as x,X as q,r as F,o as H,u as w,s as $,p as L,q as f,t as Q,v as j,d as u,w as X,x as M,y as J,z as K}from"./index-DwbuEFEH.js";import{C as W,d as Y}from"./card-DdU8Mv6S.js";import{T as Z}from"./TransactionList-DcqqMJeE.js";import{u as ee}from"./useAiFeatures-BStZ87Me.js";import{P as se}from"./PageHeader-rIQwqtJA.js";import"./use-mobile-GAj-Qur4.js";import"./EmptyState-CVo49N0l.js";/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const te=[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}]],ae=D("calendar",te);function re({className:r,date:t,onDateChange:g}){return e.jsx("div",{className:T("grid gap-2",r),children:e.jsxs(B,{children:[e.jsx(V,{asChild:!0,children:e.jsxs(A,{id:"date",variant:"outline",className:T("w-full justify-start text-left font-normal",!t&&"text-muted-foreground"),children:[e.jsx(ae,{className:"mr-2 h-4 w-4"}),t!=null&&t.from?t.to?e.jsxs(e.Fragment,{children:[z(t.from,"LLL dd, y")," -"," ",z(t.to,"LLL dd, y")]}):z(t.from,"LLL dd, y"):e.jsx("span",{children:"Pick a date range"})]})}),e.jsx(_,{className:"w-auto p-0",align:"start",children:e.jsx(G,{initialFocus:!0,mode:"range",defaultMonth:t==null?void 0:t.from,selected:t,onSelect:g,numberOfMonths:2})})]})})}const ne=({filters:r,onFiltersChange:t,accounts:g,categories:v})=>{var y;const h=(s,m)=>{if(m==null||m===""){const{[s]:k,...S}=r;t(S)}else t({...r,[s]:m})},N=()=>{t({})},l=Object.keys(r).length>0;return e.jsx(W,{className:"mb-6",children:e.jsxs(Y,{className:"p-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(I,{htmlFor:"desc-filter",children:"Description"}),e.jsx(O,{id:"desc-filter",placeholder:"Search description...",value:r.description||"",onChange:s=>h("description",s.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(I,{htmlFor:"acc-filter",children:"Account"}),e.jsxs(b,{value:((y=r.accountId)==null?void 0:y.toString())||"all",onValueChange:s=>h("accountId",s==="all"?void 0:parseInt(s)),children:[e.jsx(R,{id:"acc-filter",children:e.jsx(P,{})}),e.jsxs(U,{children:[e.jsx(x,{value:"all",children:"All Accounts"}),g.map(s=>e.jsx(x,{value:s.id.toString(),children:s.name},s.id))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(I,{htmlFor:"cat-filter",children:"Category"}),e.jsxs(b,{value:r.categoryId||"all",onValueChange:s=>h("categoryId",s==="all"?void 0:s),children:[e.jsx(R,{id:"cat-filter",children:e.jsx(P,{})}),e.jsxs(U,{children:[e.jsx(x,{value:"all",children:"All Categories"}),e.jsx(x,{value:"none",children:"Uncategorized"}),v.map(s=>e.jsx(x,{value:s.id.toString(),children:s.name},s.id))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(I,{children:"Date Range"}),e.jsx(re,{date:r.dateRange,onDateChange:s=>h("dateRange",s)})]})]}),l&&e.jsx("div",{className:"mt-4 flex justify-end",children:e.jsxs(A,{variant:"ghost",onClick:N,children:[e.jsx(q,{className:"mr-2 h-4 w-4"}),"Clear Filters"]})})]})})},he=()=>{const[r,t]=F.useState({}),[g,v]=F.useState(!1),{isAiEnabled:h}=ee(),N=H(),l=w(()=>u.transactions.orderBy("date").reverse().toArray(),[]),y=w(()=>u.accounts.toArray(),[]),s=w(()=>u.categories.toArray(),[]),m=w(()=>u.tags.toArray(),[]),k=F.useMemo(()=>l?l.filter(n=>{const{description:i,accountId:a,categoryId:d,dateRange:o}=r;return!(i&&!n.description.toLowerCase().includes(i.toLowerCase())||a&&n.accountId!==a||d&&(d==="none"&&n.categoryId!==void 0||d!=="none"&&n.categoryId!==parseInt(d))||o!=null&&o.from&&n.date<o.from||o!=null&&o.to&&n.date>o.to)}):[],[l,r]),S=async()=>{const n=$("Applying categorization rules...");try{const i=(l==null?void 0:l.filter(c=>c&&!c.categoryId))||[];if(i.length===0){L(n),f("No uncategorized transactions to process.");return}const a=await Q(i);j.info(`User rules engine updated ${a} transactions.`);const o=(await u.transactions.bulkGet(i.map(c=>c.id))).filter(c=>c&&!c.categoryId),C=await X(o);j.info(`System rule book updated ${C} transactions.`);const p=a+C;p>0?f(`Rules applied! ${p} transactions were categorized.`):f("No transactions were updated by your rules.")}catch(i){j.error("Failed to apply rules manually",{error:i}),M("An error occurred while applying rules.")}finally{L(n)}},E=async()=>{const n=k.filter(a=>!a.categoryId);if(n.length===0){f("No uncategorized transactions in the current view to suggest for.");return}v(!0);const i=$(`Asking AI to categorize ${n.length} transaction(s)...`);try{const a=await J(n);if(a.size>0){const d=Array.from(a.entries()).map(([p,c])=>({key:p,changes:{categoryId:c}}));await u.transactions.bulkUpdate(d),f(`AI successfully categorized ${a.size} transaction(s)!`),j.info(`AI categorized ${a.size} transactions from manual trigger.`);const o=d.map(p=>p.key),C=await u.transactions.bulkGet(o);await K(C,N)}else f("AI couldn't find any new categories for these transactions.")}catch(a){j.error("Failed to suggest categories",{error:a}),M(a instanceof Error?a.message:"An unexpected error occurred.")}finally{L(i),v(!1)}};return e.jsxs(e.Fragment,{children:[e.jsxs(se,{title:"Transactions ðŸ§¾",children:[e.jsxs(A,{variant:"outline",onClick:S,children:[e.jsx("span",{className:"mr-2",children:"ðŸ¤–"}),"Apply Rules"]}),e.jsxs(A,{variant:"outline",onClick:E,disabled:!h||g,children:[e.jsx("span",{className:"mr-2",children:"âœ¨"}),g?"Thinking...":"Suggest"]})]}),e.jsx(ne,{filters:r,onFiltersChange:t,accounts:y||[],categories:s||[]}),e.jsx(Z,{transactions:k,accounts:y||[],categories:s||[],tags:m||[]})]})};export{he as default};
