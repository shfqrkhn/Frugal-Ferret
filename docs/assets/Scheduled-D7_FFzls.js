import{a as _,u as w,Y as G,j as e,$ as J,a0 as j,a1 as p,a2 as g,a3 as y,I as R,a4 as f,i as F,k as P,l as M,m as E,n as N,a5 as $,P as H,e as Y,B as x,f as b,c as T,g as Q,C as L,Z as X,_ as ee,at as W,a7 as se,a6 as k,au as ne,d as m,a8 as re,a9 as ce,aa as te,ab as oe,ac as ae,v as C,q as A,x as I,K as de,M as le,N as ie,O as ue,Q as he,R as xe,U as me,V as je,W as pe,r as S,s as ge,av as ye,p as fe,aw as Se,S as q}from"./index-Xj3-ztsO.js";import{C as D,a as O,b as U,d as z,e as Ne,c as K}from"./card-DpOJR0o6.js";import{u as Ce}from"./useAiFeatures-BoFMrtPk.js";import{s as ve}from"./subMonths-Du8FVnST.js";import{P as we}from"./PageHeader-C4PCHSjN.js";import{E as Ae}from"./EmptyState-DTePYbNB.js";const Z=["daily","weekly","bi-weekly","monthly","yearly"],be=ee({description:k().min(2,{message:"Description must be at least 2 characters."}),amount:ne.number().refine(t=>t!==0,{message:"Amount cannot be zero."}),accountId:k().min(1,{message:"Please select an account."}),categoryId:k().optional(),frequency:se(Z),startDate:W(),endDate:W().optional()}),Te=({onSubmit:t,onCancel:o,initialData:s})=>{var h,u;const{openAddAccountDialog:d,openCategoryDialog:r}=_(),n=w(()=>m.accounts.toArray(),[]),i=w(()=>m.categories.orderBy("name").toArray(),[]),l=G({resolver:X(be),defaultValues:{description:(s==null?void 0:s.description)||"",amount:(s==null?void 0:s.amount)||0,accountId:((h=s==null?void 0:s.accountId)==null?void 0:h.toString())||"",categoryId:(u=s==null?void 0:s.categoryId)==null?void 0:u.toString(),frequency:(s==null?void 0:s.frequency)||"monthly",startDate:(s==null?void 0:s.startDate)||new Date,endDate:s==null?void 0:s.endDate}});return e.jsx(J,{...l,children:e.jsxs("form",{onSubmit:l.handleSubmit(t),className:"space-y-4",children:[e.jsx(j,{control:l.control,name:"description",render:({field:c})=>e.jsxs(p,{children:[e.jsx(g,{children:"Description"}),e.jsx(y,{children:e.jsx(R,{placeholder:"e.g., Netflix Subscription",...c,autoFocus:!0})}),e.jsx(f,{})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(j,{control:l.control,name:"amount",render:({field:c})=>e.jsxs(p,{children:[e.jsx(g,{children:"Amount"}),e.jsx(y,{children:e.jsx(R,{type:"number",step:"0.01",placeholder:"0.00",...c})}),e.jsx(f,{})]})}),e.jsx(j,{control:l.control,name:"accountId",render:({field:c})=>e.jsxs(p,{children:[e.jsx(g,{children:"Account"}),e.jsxs(F,{onValueChange:a=>{a==="add-new"?d():c.onChange(a)},value:c.value,children:[e.jsx(y,{children:e.jsx(P,{children:e.jsx(M,{placeholder:"Select an account"})})}),e.jsxs(E,{children:[n==null?void 0:n.map(a=>e.jsx(N,{value:a.id.toString(),children:a.name},a.id)),e.jsx($,{}),e.jsx(N,{value:"add-new",children:e.jsx("span",{className:"font-medium text-primary",children:"➕ Add new account..."})})]})]}),e.jsx(f,{})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(j,{control:l.control,name:"frequency",render:({field:c})=>e.jsxs(p,{children:[e.jsx(g,{children:"Frequency"}),e.jsxs(F,{onValueChange:c.onChange,value:c.value,children:[e.jsx(y,{children:e.jsx(P,{children:e.jsx(M,{})})}),e.jsx(E,{children:Z.map(a=>e.jsx(N,{value:a,children:a.replace(/-/g," ").replace(/\b\w/g,v=>v.toUpperCase())},a))})]}),e.jsx(f,{})]})}),e.jsx(j,{control:l.control,name:"categoryId",render:({field:c})=>e.jsxs(p,{children:[e.jsx(g,{children:"Category (Optional)"}),e.jsxs(F,{onValueChange:a=>{a==="add-new"?r():c.onChange(a)},value:c.value,children:[e.jsx(y,{children:e.jsx(P,{children:e.jsx(M,{placeholder:"Select a category"})})}),e.jsxs(E,{children:[e.jsx(N,{value:"none",children:"Uncategorized"}),i==null?void 0:i.map(a=>e.jsx(N,{value:a.id.toString(),children:a.name},a.id)),e.jsx($,{}),e.jsx(N,{value:"add-new",children:e.jsx("span",{className:"font-medium text-primary",children:"➕ Add new category..."})})]})]}),e.jsx(f,{})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(j,{control:l.control,name:"startDate",render:({field:c})=>e.jsxs(p,{children:[e.jsx(g,{children:"Start Date"}),e.jsxs(H,{children:[e.jsx(Y,{asChild:!0,children:e.jsx(y,{children:e.jsxs(x,{variant:"outline",className:T("w-full pl-3 text-left font-normal",!c.value&&"text-muted-foreground"),children:[c.value?b(c.value,"PPP"):e.jsx("span",{children:"Pick a date"}),e.jsx("span",{className:"ml-auto h-4 w-4 opacity-50",children:"📅"})]})})}),e.jsx(Q,{className:"w-auto p-0",align:"start",children:e.jsx(L,{mode:"single",selected:c.value,onSelect:c.onChange,initialFocus:!0})})]}),e.jsx(f,{})]})}),e.jsx(j,{control:l.control,name:"endDate",render:({field:c})=>e.jsxs(p,{children:[e.jsx(g,{children:"End Date (Optional)"}),e.jsxs(H,{children:[e.jsx(Y,{asChild:!0,children:e.jsx(y,{children:e.jsxs(x,{variant:"outline",className:T("w-full pl-3 text-left font-normal",!c.value&&"text-muted-foreground"),children:[c.value?b(c.value,"PPP"):e.jsx("span",{children:"Never"}),e.jsx("span",{className:"ml-auto h-4 w-4 opacity-50",children:"📅"})]})})}),e.jsx(Q,{className:"w-auto p-0",align:"start",children:e.jsx(L,{mode:"single",selected:c.value,onSelect:c.onChange})})]}),e.jsx(f,{})]})})]}),e.jsxs("div",{className:"flex justify-end space-x-2 pt-4",children:[e.jsx(x,{type:"button",variant:"outline",onClick:o,children:"Cancel"}),e.jsx(x,{type:"submit",disabled:!n||n.length===0,children:s!=null&&s.id?"Save Changes":"Add Schedule"})]})]})})},Ie=({isOpen:t,onClose:o,initialData:s})=>{const d=async r=>{try{const n={accountId:parseInt(r.accountId,10),description:r.description,amount:r.amount,categoryId:r.categoryId&&r.categoryId!=="none"?parseInt(r.categoryId,10):void 0,frequency:r.frequency,startDate:r.startDate,endDate:r.endDate,nextDueDate:r.startDate,createdAt:(s==null?void 0:s.createdAt)||new Date};s!=null&&s.id?(await m.scheduledTransactions.update(s.id,n),C.info("Scheduled transaction updated",{id:s.id,...n}),A("Scheduled transaction updated successfully!")):(await m.scheduledTransactions.add(n),C.info("Scheduled transaction added",n),A("Scheduled transaction added successfully!")),o()}catch(n){C.error("Failed to save scheduled transaction",{error:n,values:r}),I("Failed to save scheduled transaction.")}};return e.jsx(re,{open:t,onOpenChange:o,children:e.jsxs(ce,{children:[e.jsxs(te,{children:[e.jsxs(oe,{children:[s!=null&&s.id?"Edit":"Add"," Scheduled Transaction"]}),e.jsx(ae,{children:"Schedule a recurring income or expense. It will be automatically created on its due date."})]}),e.jsx(Te,{onSubmit:d,onCancel:o,initialData:s})]})})},Fe=({st:t,accountName:o,onEdit:s,onDelete:d})=>{const r=t.frequency.replace(/-/g," ").replace(/\b\w/g,n=>n.toUpperCase());return e.jsxs(D,{children:[e.jsx(O,{children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx(U,{children:t.description}),e.jsx("p",{className:"text-sm text-muted-foreground",children:o})]}),e.jsx("p",{className:T("font-mono text-lg",t.amount<0?"text-destructive":"text-green-600"),children:t.amount.toLocaleString("en-US",{style:"currency",currency:"CAD"})})]})}),e.jsxs(z,{children:[e.jsxs("p",{className:"text-sm",children:["Next due: ",e.jsx("span",{className:"font-medium",children:b(t.nextDueDate,"MMM d, yyyy")})]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Repeats: ",r]})]}),e.jsxs(Ne,{className:"flex justify-end gap-2",children:[e.jsxs(x,{variant:"ghost",size:"sm",onClick:()=>s(t),children:[e.jsx("span",{className:"mr-1",children:"✏️"})," Edit"]}),e.jsxs(de,{children:[e.jsx(le,{asChild:!0,children:e.jsxs(x,{variant:"ghost",size:"sm",className:"text-destructive hover:text-destructive",children:[e.jsx("span",{className:"mr-1",children:"🗑️"})," Delete"]})}),e.jsxs(ie,{children:[e.jsxs(ue,{children:[e.jsx(he,{children:"Are you sure?"}),e.jsx(xe,{children:"This will permanently delete this scheduled transaction. This action cannot be undone."})]}),e.jsxs(me,{children:[e.jsx(je,{children:"Cancel"}),e.jsx(pe,{onClick:()=>d(t.id),children:"Delete"})]})]})]})]})]})},Pe=({scheduledTransactions:t,onEdit:o})=>{const s=w(()=>m.accounts.toArray(),[]),d=new Map(s==null?void 0:s.map(n=>[n.id,n.name])),r=async n=>{try{await m.scheduledTransactions.delete(n),A("Scheduled transaction deleted."),C.info(`Scheduled transaction ${n} deleted.`)}catch(i){I("Failed to delete scheduled transaction."),C.error(`Failed to delete scheduled transaction ${n}`,{error:i})}};return e.jsx("div",{className:"grid gap-4 md:grid-cols-2 xl:grid-cols-3",children:t.map(n=>e.jsx(Fe,{st:n,accountName:d.get(n.accountId)||"Unknown Account",onEdit:o,onDelete:r},n.id))})},Me=({onPropose:t})=>{const{isAiEnabled:o}=Ce(),[s,d]=S.useState(!1),[r,n]=S.useState([]),i=w(()=>m.scheduledTransactions.toArray()),l=async()=>{d(!0);const h=ge("Scanning transaction history...");try{const u=ve(new Date,3),c=await m.transactions.where("date").aboveOrEqual(u).toArray();if(c.length<10){I("Not enough transaction history to analyze. Please add more transactions.");return}const v=(await ye(c)).filter(B=>!(i!=null&&i.some(V=>V.description.toLowerCase()===B.description.toLowerCase()&&V.amount===B.amount)));n(v),v.length>0?A(`Found ${v.length} potential recurring transaction(s)!`):A("No new recurring transactions found.")}catch(u){C.error("Failed to scan for scheduled transactions",{error:u}),I(u instanceof Error?u.message:"An unexpected error occurred.")}finally{fe(h),d(!1)}};return o?e.jsxs(D,{children:[e.jsxs(O,{children:[e.jsx(U,{children:"Find Recurring Transactions ✨"}),e.jsx(K,{children:"Let AI scan your recent history to find potential scheduled transactions you can add."})]}),e.jsxs(z,{className:"space-y-4",children:[e.jsx(x,{onClick:l,disabled:s,children:s?"Scanning...":"Scan for Recurring Transactions"}),r.length>0&&e.jsxs("div",{className:"space-y-2 pt-4",children:[e.jsx("h4",{className:"font-medium",children:"Suggestions"}),r.map((h,u)=>e.jsxs("div",{className:"flex items-center justify-between rounded-md border p-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:h.description}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[h.amount.toLocaleString("en-US",{style:"currency",currency:"CAD"})," / ",h.frequency]})]}),e.jsx(x,{size:"sm",onClick:()=>t(h),children:"Add"})]},u))]})]})]}):null},Ee=({scheduledTransactions:t})=>{const[o,s]=S.useState(new Date),d=S.useMemo(()=>t.map(n=>n.nextDueDate),[t]),r=S.useMemo(()=>o?t.filter(n=>Se(n.nextDueDate,o)):[],[o,t]);return e.jsxs(D,{children:[e.jsxs(O,{children:[e.jsx(U,{children:"Bill Calendar"}),e.jsx(K,{children:"Upcoming due dates for your scheduled transactions."})]}),e.jsxs(z,{className:"grid gap-6 md:grid-cols-2",children:[e.jsx("div",{children:e.jsx(L,{mode:"single",selected:o,onSelect:s,className:"rounded-md border",modifiers:{due:d},modifiersStyles:{due:{fontWeight:"bold",textDecoration:"underline"}}})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"font-semibold",children:o?`Due on ${b(o,"MMM d, yyyy")}`:"Select a date"}),r.length>0?e.jsx("ul",{className:"space-y-3",children:r.map(n=>e.jsx("li",{className:"flex justify-between items-center",children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:n.description}),e.jsx("p",{className:T("font-mono text-sm",n.amount<0?"text-destructive":"text-green-600"),children:n.amount.toLocaleString("en-US",{style:"currency",currency:"CAD"})})]})},n.id))}):e.jsx("p",{className:"text-sm text-muted-foreground pt-4 text-center",children:"No bills due on this day."})]})]})]})},ze=()=>{const[t,o]=S.useState(!1),[s,d]=S.useState(null),r=w(()=>m.scheduledTransactions.orderBy("nextDueDate").toArray()),n=l=>{d(l||null),o(!0)},i=()=>{d(null),o(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(we,{title:"Scheduled Transactions 🗓️",children:e.jsxs(x,{onClick:()=>n(),children:[e.jsx("span",{className:"mr-2",children:"➕"}),"Add Scheduled"]})}),e.jsx("div",{className:"mb-8",children:e.jsx(Me,{onPropose:n})}),r&&r.length>0&&e.jsx("div",{className:"mb-8",children:e.jsx(Ee,{scheduledTransactions:r})}),r?r.length>0?e.jsx(Pe,{scheduledTransactions:r,onEdit:n}):e.jsx(Ae,{icon:"🗓️",title:"No Scheduled Transactions Yet",description:"Schedule recurring bills or income to automate your finances.",action:{text:"Schedule Your First Transaction",onClick:()=>n()}}):e.jsxs("div",{className:"grid gap-4 md:grid-cols-2 xl:grid-cols-3",children:[e.jsx(q,{className:"h-28 w-full"}),e.jsx(q,{className:"h-28 w-full"}),e.jsx(q,{className:"h-28 w-full"})]}),e.jsx(Ie,{isOpen:t,onClose:i,initialData:s||void 0})]})};export{ze as default};
